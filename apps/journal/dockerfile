FROM node:24-alpine AS builder
WORKDIR /app
RUN corepack enable && corepack prepare pnpm@latest --activate

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml tsconfig.base.json ./
COPY apps/journal/package.json apps/journal/package.json
COPY shared/package.json shared/package.json

RUN pnpm install --frozen-lockfile --filter journal... --filter @my-apps/shared...

COPY apps/journal ./apps/journal
COPY shared ./shared
RUN pnpm --filter @my-apps/shared... build
RUN pnpm --filter journal... build

FROM node:24-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production

COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/apps/journal/node_modules ./apps/journal/node_modules
COPY --from=builder /app/apps/journal/dist ./apps/journal/dist
COPY --from=builder /app/apps/journal/package.json ./apps/journal/package.json
COPY --from=builder /app/shared ./shared

WORKDIR /app/apps/journal
EXPOSE 4051

CMD ["node", "dist/main.js"]